*****************************************************************
* 業務仕様説明（FUNCTION-002 満期・前倒し精算処理）
*---------------------------------------------------------------*
* UPDATE :
*   2026/01/19 : 初版作成（仕様再整理）
*---------------------------------------------------------------*
* プログラムID : PGM001
* 機能ID       : FUNCTION-002
*****************************************************************

■ 1. 機能概要
---------------------------------------------------------------
本機能は、銀行ABCの預金管理システムにおいて、
有効な預金契約（DB_ACCOUNT_SAVINGS.STATUS = '1'）を対象に、
満期到達または前倒し解約を判定し、利息計算・精算処理を行い、
口座残高および契約ステータスを更新するバッチ処理である。

本機能では、
・利息計算
・精算金額算出
・DB更新
・COMMIT / ROLLBACK
を行う。

---------------------------------------------------------------

■ 2. 起動条件
---------------------------------------------------------------
JCL パラメータ（PARM）により本機能を制御する。

・PARM = '2'
・PARM = '3'

上記の場合のみ FUNCTION-002 を実行する。
それ以外の場合、本機能は実行しない。

---------------------------------------------------------------

■ 3. 対象テーブル
---------------------------------------------------------------
【DB_ACCOUNT_SAVINGS】
  - ORDER_ID
  - ACC_ID
  - SAVING_TYPE
  - START_DATE
  - END_DATE
  - MONEY_ROOT
  - STATUS

【DB_INTEREST_INFO】
  - SAVING_TYPE
  - INTEREST_RATE

【DB_ACCOUNT_BALANCE】
  - ACC_ID
  - BALANCE

---------------------------------------------------------------

■ 4. 対象データ抽出条件
---------------------------------------------------------------
DB_ACCOUNT_SAVINGS より以下条件でカーソル取得する。

  STATUS = '1'

※ すでに精算済み（STATUS ≠ '1'）の契約は対象外とする。

---------------------------------------------------------------

■ 5. 日付判定ロジック
---------------------------------------------------------------
以下の日付を使用する。

・CURRENT-DATE（バッチ実行日）
・START_DATE（契約開始日）
・END_DATE（契約満期日）

① 経過日数算出
   経過日数 = CURRENT-DATE - START_DATE

   ※ 経過日数 < 0 の場合は 0 とする

② 満期判定
   ・CURRENT-DATE >= END_DATE → 満期到達
   ・CURRENT-DATE <  END_DATE → 前倒し解約

---------------------------------------------------------------

■ 6. 利息計算ロジック（単利）
---------------------------------------------------------------

【共通】
・利率は DB_INTEREST_INFO より取得する
・利息は単利で計算する
・365 日基準とする

---------------------------------------------------------------
【6.1 非定期預金（NON-TERM）】
---------------------------------------------------------------
利息 ＝ MONEY_ROOT × 非定期利率 × 経過日数 ÷ 365

※ 満期概念はなく、常に上記計算を使用する

---------------------------------------------------------------
【6.2 定期預金（FIXED-03 / FIXED-06 / FIXED-12）】
---------------------------------------------------------------

■ 満期到達（CURRENT-DATE >= END_DATE）

  契約日数：
    FIXED-03 ＝  90 日
    FIXED-06 ＝ 180 日
    FIXED-12 ＝ 365 日

  利息 ＝ MONEY_ROOT × 定期利率 × 契約日数 ÷ 365

---------------------------------------------------------------
■ 前倒し解約（CURRENT-DATE < END_DATE）

  利息 ＝ MONEY_ROOT × 非定期利率 × 経過日数 ÷ 365

---------------------------------------------------------------

■ 7. 精算金額算出
---------------------------------------------------------------
精算金額（MONEY）は以下とする。

  MONEY ＝ MONEY_ROOT + INTEREST

---------------------------------------------------------------

■ 8. DB 更新処理
---------------------------------------------------------------

【8.1 DB_ACCOUNT_BALANCE 更新】

  対象：ACC_ID
  処理：
    BALANCE = BALANCE + MONEY

---------------------------------------------------------------

【8.2 DB_ACCOUNT_SAVINGS 更新】

  対象：ORDER_ID
  処理：
    STATUS = '9'（精算済）

※ 利息金額・合計金額は
   DB_ACCOUNT_SAVINGS には保持しない

---------------------------------------------------------------

■ 9. トランザクション制御
---------------------------------------------------------------
・全件正常処理完了後、COMMIT を 1 回実行する
・途中エラー発生時は ROLLBACK を実行する

---------------------------------------------------------------

■ 10. エラー処理
---------------------------------------------------------------
SQL 実行時、以下条件の場合は異常終了とする。

・SQLCODE < 0

【異常時処理】
  ・CST-ABEND-BREAKPOINT に処理名設定
  ・エラーメッセージ出力
  ・ROLLBACK 実行
  ・STOP RUN

---------------------------------------------------------------

■ 11. 備考
---------------------------------------------------------------
・FUNCTION-001（プレビュー処理）とは異なり、
  本機能では DB 更新を行う
・画面表示目的の処理は行わない

*****************************************************************
